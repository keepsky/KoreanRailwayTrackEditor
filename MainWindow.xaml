<Window x:Class="KoreanRailwayTrackEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:KoreanRailwayTrackEditor"
        xmlns:vm="clr-namespace:KoreanRailwayTrackEditor.ViewModels"
        xmlns:models="clr-namespace:KoreanRailwayTrackEditor.Models"
        xmlns:converters="clr-namespace:KoreanRailwayTrackEditor.Converters"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="Korean Railway Track Editor" Height="600" Width="1000">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <converters:DirectionToBooleanConverter x:Key="DirectionToBooleanConverter"/>
        <converters:RelativePositionConverter x:Key="RelativePositionConverter"/>
        <converters:GapOffsetConverter x:Key="GapOffsetConverter"/>
        <converters:ScaleConverter x:Key="ScaleConverter"/>
        <converters:MidpointRelativeConverter x:Key="MidpointRelativeConverter"/>
        <converters:AngleConverter x:Key="AngleConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- Signal Vector Templates -->
        <DrawingImage x:Key="SignalMainIcon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <!-- Red Ellipse -->
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <EllipseGeometry Center="83,26" RadiusX="25" RadiusY="25"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- Connecting Line -->
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="6"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="0,26" EndPoint="58,26"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- Vertical Line -->
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="6"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="3,7.25" EndPoint="3,44.75"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- White Ellipse -->
                    <GeometryDrawing Brush="White">
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <EllipseGeometry Center="28,26" RadiusX="15" RadiusY="15"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="SignalGuideIcon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="6"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="0,21.52" EndPoint="42,21.6"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <GeometryDrawing Brush="White">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <RectangleGeometry Rect="2,13.59,36,16" RadiusX="8" RadiusY="8">
                                <RectangleGeometry.Transform>
                                    <RotateTransform Angle="60" CenterX="20" CenterY="21.59"/>
                                </RectangleGeometry.Transform>
                            </RectangleGeometry>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="SignalShuntIcon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <PathGeometry Figures="M 51 51 L 51 1 C 78.61 1 101 23.39 101 51 Z"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="SignalIndIcon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <!-- Red Pie Chart -->
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <PathGeometry Figures="M 55 51 L 55 1 C 82.61 1 105 23.39 105 51 Z"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- Connecting Line -->
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="6"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="2,26" EndPoint="57,26"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- Vertical Line -->
                    <GeometryDrawing>
                        <GeometryDrawing.Pen>
                            <Pen Brush="Black" Thickness="6"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <LineGeometry StartPoint="2,7.25" EndPoint="2,44.75"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="Signal3Icon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <EllipseGeometry Center="26,26" RadiusX="25" RadiusY="25"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="Signal4Icon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <EllipseGeometry Center="26,26" RadiusX="25" RadiusY="25"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <GeometryDrawing Brush="#FF0000">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <EllipseGeometry Center="76,26" RadiusX="25" RadiusY="25"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <DrawingImage x:Key="SignalRouteIcon">
             <DrawingImage.Drawing>
                 <DrawingGroup>
                     <GeometryDrawing>
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="6"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <LineGeometry StartPoint="0,16" EndPoint="43,16"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                     <GeometryDrawing Brush="White">
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="3"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <EllipseGeometry Center="21,16" RadiusX="15" RadiusY="15"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                 </DrawingGroup>
             </DrawingImage.Drawing>
         </DrawingImage>
 
         <DrawingImage x:Key="SignalBarIcon">
             <DrawingImage.Drawing>
                 <DrawingGroup>
                     <GeometryDrawing>
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="6"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <LineGeometry StartPoint="3,3" EndPoint="3,40.5"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                     <GeometryDrawing>
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="6"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <LineGeometry StartPoint="0,21.64" EndPoint="17,21.75"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                 </DrawingGroup>
             </DrawingImage.Drawing>
         </DrawingImage>
 
         <DrawingImage x:Key="SignalBar2Icon">
             <DrawingImage.Drawing>
                 <DrawingGroup>
                     <GeometryDrawing>
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="6"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <LineGeometry StartPoint="3,3" EndPoint="3,40.5"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                     <GeometryDrawing>
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="6"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <LineGeometry StartPoint="0,21.64" EndPoint="47,22"/>
                         </GeometryDrawing.Geometry>
                     </GeometryDrawing>
                 </DrawingGroup>
             </DrawingImage.Drawing>
         </DrawingImage>
 
         <DrawingImage x:Key="SignalSisoIcon">
             <DrawingImage.Drawing>
                 <DrawingGroup>
                     <GeometryDrawing Brush="White">
                         <GeometryDrawing.Pen>
                             <Pen Brush="#868686" Thickness="3"/>
                         </GeometryDrawing.Pen>
                         <GeometryDrawing.Geometry>
                             <EllipseGeometry Center="16,16" RadiusX="15" RadiusY="15"/>
                         </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <!-- Signal TTB Icon (Rectangle with T) -->
        <DrawingImage x:Key="SignalTtbIcon">
            <DrawingImage.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="Transparent">
                        <GeometryDrawing.Pen>
                            <Pen Brush="#868686" Thickness="3"/>
                        </GeometryDrawing.Pen>
                        <GeometryDrawing.Geometry>
                            <RectangleGeometry Rect="0,0,43,43"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <!-- Synthesized 'T' shape -->
                    <GeometryDrawing Brush="#00FF00">
                        <GeometryDrawing.Geometry>
                            <PathGeometry Figures="M 12 10 L 32 10 L 32 16 L 25 16 L 25 36 L 19 36 L 19 16 L 12 16 Z"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>

        <ControlTemplate x:Key="SignalTemplate">
             <Viewbox Height="20" Stretch="Uniform">
                 <StackPanel Orientation="Horizontal" FlowDirection="RightToLeft">
                    <!-- TTB (Only for Main3/Main45 + HasTtb=True) -->
                    <Image Source="{StaticResource SignalTtbIcon}" Width="43" Height="43" x:Name="TtbImage" Visibility="Collapsed"/>

                     <!-- Main Signal Body -->
                     <Image x:Name="SignalBody">
                         <Image.Style>
                             <Style TargetType="Image">
                                 <!-- Default (Main3) -->
                                 <Setter Property="Source" Value="{StaticResource Signal3Icon}"/>
                                 <Setter Property="Width" Value="53"/>
                                 <Setter Property="Height" Value="53"/>
                                 <Style.Triggers>
                                     <DataTrigger Binding="{Binding Type}" Value="Main45">
                                        <Setter Property="Source" Value="{StaticResource Signal4Icon}"/>
                                        <Setter Property="Width" Value="103"/>
                                        <Setter Property="Height" Value="53"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Type}" Value="Shunt">
                                        <Setter Property="Source" Value="{StaticResource SignalShuntIcon}"/>
                                        <Setter Property="Width" Value="53"/>
                                        <Setter Property="Height" Value="53"/>
                                        <Setter Property="FlowDirection" Value="LeftToRight"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Image.Style>
                    </Image>

                     <!-- Guide (Only for Main3/Main45) -->
                     <Image Source="{StaticResource SignalGuideIcon}" Width="42" Height="44" Visibility="{Binding HasGuide, Converter={StaticResource BooleanToVisibilityConverter}}" VerticalAlignment="Center"/>
 
                     <!-- Route (Only for Main3/Main45) or NoGuide (Only for Shunt) -->
                     <Image Source="{StaticResource SignalRouteIcon}" Width="43" Height="33" x:Name="RouteImage" Visibility="Collapsed"/>
                    
                    <!-- Bar (Connector) -->
                    <Image Source="{StaticResource SignalBarIcon}" Width="17" Height="45" x:Name="BarImage"/>

                    <!-- Siso -->
                    <Image Source="{StaticResource SignalSisoIcon}" Width="33" Height="33" Visibility="{Binding IsSiso, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    

                </StackPanel>
            </Viewbox>
            <ControlTemplate.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Shunt"/>
                        <Condition Binding="{Binding HasNoGuide}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="RouteImage" Property="Visibility" Value="Visible"/>
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main3"/>
                        <Condition Binding="{Binding HasRoute}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="RouteImage" Property="Visibility" Value="Visible"/>
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main45"/>
                        <Condition Binding="{Binding HasRoute}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="RouteImage" Property="Visibility" Value="Visible"/>
                </MultiDataTrigger>

                <!-- Trigger for Bar Icon Switch (Main3/Main45 + NoGuide + NoRoute -> SignalBar2) -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main3"/>
                        <Condition Binding="{Binding HasGuide}" Value="False"/>
                        <Condition Binding="{Binding HasRoute}" Value="False"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="BarImage" Property="Source" Value="{StaticResource SignalBar2Icon}"/>
                    <Setter TargetName="BarImage" Property="Width" Value="47"/>
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main45"/>
                        <Condition Binding="{Binding HasGuide}" Value="False"/>
                        <Condition Binding="{Binding HasRoute}" Value="False"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="BarImage" Property="Source" Value="{StaticResource SignalBar2Icon}"/>
                    <Setter TargetName="BarImage" Property="Width" Value="47"/>
                </MultiDataTrigger>
                
                <!-- Trigger for Bar Icon Switch (Shunt + NoGuide Unchecked -> SignalBar2) -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                         <Condition Binding="{Binding Type}" Value="Shunt"/>
                         <Condition Binding="{Binding HasNoGuide}" Value="False"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="BarImage" Property="Source" Value="{StaticResource SignalBar2Icon}"/>
                    <Setter TargetName="BarImage" Property="Width" Value="47"/>
                </MultiDataTrigger>
                
                <!-- TTB Triggers -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main3"/>
                        <Condition Binding="{Binding HasTtb}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="TtbImage" Property="Visibility" Value="Visible"/>
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Type}" Value="Main45"/>
                        <Condition Binding="{Binding HasTtb}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="TtbImage" Property="Visibility" Value="Visible"/>
                </MultiDataTrigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <Style x:Key="SignalControlStyle" TargetType="Control">
            <Setter Property="Template" Value="{StaticResource SignalTemplate}"/>
        </Style>


        <converters:SignalTypeToImageConverter x:Key="SignalTypeToImageConverter"/>
        <ObjectDataProvider x:Key="SignalTypeEnum" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:SignalType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>



        <!-- DataTemplates for rendering components on Canvas -->
        <DataTemplate DataType="{x:Type models:Signal}">
            <Control x:Name="SignalControl" Style="{StaticResource SignalControlStyle}" ToolTip="{Binding Type}" RenderTransformOrigin="0.5,0.5">
                <Control.RenderTransform>
                    <ScaleTransform ScaleX="0.5" ScaleY="0.5"/>
                </Control.RenderTransform>
            </Control>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding Direction}" Value="Up">
                    <Setter TargetName="SignalControl" Property="RenderTransform">
                        <Setter.Value>
                            <ScaleTransform ScaleX="-0.5" ScaleY="0.5"/>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate DataType="{x:Type models:Switch}">
            <Canvas>
                <!-- Line A-S (left to center) -->
                <Line x:Name="LineAS" Stroke="Gray" StrokeThickness="15" StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                    <Line.X1>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="AX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X1>
                    <Line.Y1>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="AY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y1>
                    <Line.X2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X2>
                    <Line.Y2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y2>
                </Line>
                
                <!-- Line S-R (center to reverse, with gap at S) -->
                <Line x:Name="LineSR" Stroke="Gray" StrokeThickness="15" StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                    <Line.X1>
                        <MultiBinding Converter="{StaticResource GapOffsetConverter}" ConverterParameter="StartX">
                            <Binding Path="SX"/>
                            <Binding Path="SY"/>
                            <Binding Path="RX"/>
                            <Binding Path="RY"/>
                            <Binding Path="X"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.X1>
                    <Line.Y1>
                        <MultiBinding Converter="{StaticResource GapOffsetConverter}" ConverterParameter="StartY">
                            <Binding Path="SX"/>
                            <Binding Path="SY"/>
                            <Binding Path="RX"/>
                            <Binding Path="RY"/>
                            <Binding Path="X"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y1>
                    <Line.X2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="RX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X2>
                    <Line.Y2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="RY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y2>
                </Line>
                
                <!-- Line S-N (center to normal) -->
                <Line x:Name="LineSN" Stroke="Gray" StrokeThickness="15" StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                    <Line.X1>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X1>
                    <Line.Y1>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y1>
                    <Line.X2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="NX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X2>
                    <Line.Y2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="NY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y2>
                </Line>
                
                <!-- Track ID Label on S-N line -->
                <Border Background="White" BorderBrush="Gray" BorderThickness="1" CornerRadius="2" Padding="2,1,2,1" RenderTransformOrigin="0.5,0.5">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource MidpointRelativeConverter}">
                            <Binding Path="SX"/>
                            <Binding Path="NX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource MidpointRelativeConverter}">
                            <Binding Path="SY"/>
                            <Binding Path="NY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <Border.RenderTransform>
                        <TransformGroup>
                            <TranslateTransform 
                                X="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource ScaleConverter}, ConverterParameter=-0.5}"
                                Y="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource ScaleConverter}, ConverterParameter=-0.5}"/>
                            <RotateTransform>
                                <RotateTransform.Angle>
                                    <MultiBinding Converter="{StaticResource AngleConverter}">
                                        <Binding Path="SX"/>
                                        <Binding Path="SY"/>
                                        <Binding Path="NX"/>
                                        <Binding Path="NY"/>
                                    </MultiBinding>
                                </RotateTransform.Angle>
                            </RotateTransform>
                        </TransformGroup>
                    </Border.RenderTransform>
                    <TextBlock Text="{Binding TrackId}" FontWeight="Bold" FontSize="8"/>
                </Border>
                
                <!-- Switch ID and Status Circle below S -->
                <StackPanel Orientation="Horizontal">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <StackPanel.RenderTransform>
                        <TranslateTransform 
                            X="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=StackPanel}, Converter={StaticResource ScaleConverter}, ConverterParameter=-0.5}"
                            Y="15"/>
                    </StackPanel.RenderTransform>
                    
                    <Border Background="White" BorderBrush="Black" BorderThickness="1" CornerRadius="8" Padding="2,0" Margin="0,0,3,0" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Id}" FontSize="8" FontWeight="Bold"/>
                    </Border>
                    <Ellipse x:Name="StatusCircle" Width="8" Height="8" Stroke="Black" StrokeThickness="1" Fill="Green" VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Handle A -->
                <Ellipse Width="10" Height="10" Fill="Blue" Stroke="Black" Tag="A" Cursor="SizeAll" Margin="-5,-5,0,0">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="AX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="AY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                </Ellipse>
                
                <!-- Handle S -->
                <Ellipse Width="10" Height="10" Fill="Green" Stroke="Black" Tag="S" Cursor="SizeAll" Margin="-5,-5,0,0">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="SY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                </Ellipse>
                
                <!-- Handle R -->
                <Ellipse Width="10" Height="10" Fill="Red" Stroke="Black" Tag="R" Cursor="SizeAll" Margin="-5,-5,0,0">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="RX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="RY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                </Ellipse>
                
                <!-- Handle N -->
                <Ellipse Width="10" Height="10" Fill="Blue" Stroke="Black" Tag="N" Cursor="SizeAll" Margin="-5,-5,0,0">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="NX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="NY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                </Ellipse>
            </Canvas>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsOccupied}" Value="True">
                    <Setter TargetName="LineAS" Property="Stroke" Value="Red"/>
                    <Setter TargetName="LineSR" Property="Stroke" Value="Red"/>
                    <Setter TargetName="LineSN" Property="Stroke" Value="Red"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsReverse}" Value="True">
                    <Setter TargetName="StatusCircle" Property="Fill" Value="Red"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>

        <DataTemplate DataType="{x:Type models:TrackCircuit}">
            <Canvas>
                <Line x:Name="TrackLine" Stroke="Gray" StrokeThickness="15" X1="0" Y1="0" StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                    <Line.X2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="EndX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Line.X2>
                    <Line.Y2>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="EndY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Line.Y2>
                </Line>

                <!-- Centered ID Label -->
                <Border Background="White" BorderBrush="Gray" BorderThickness="1" CornerRadius="2" Padding="2,1,2,1">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}" ConverterParameter="0.5">
                            <Binding Path="EndX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}" ConverterParameter="0.5">
                            <Binding Path="EndY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                    <Border.RenderTransform>
                        <TranslateTransform 
                            X="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource ScaleConverter}, ConverterParameter=-0.5}"
                            Y="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Border}, Converter={StaticResource ScaleConverter}, ConverterParameter=-0.5}"/>
                    </Border.RenderTransform>
                    <TextBlock Text="{Binding Id}" FontWeight="Bold" FontSize="8"/>
                </Border>
                
                <!-- Start Handle -->
                <Ellipse Width="10" Height="10" Fill="Blue" Stroke="Black" Tag="Start" Canvas.Left="-5" Canvas.Top="-5" Cursor="SizeAll"/>
                
                <!-- End Handle -->
                <Ellipse Width="10" Height="10" Fill="Blue" Stroke="Black" Tag="End" Cursor="SizeAll" Margin="-5,-5,0,0">
                    <Canvas.Left>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="EndX"/>
                            <Binding Path="X"/>
                        </MultiBinding>
                    </Canvas.Left>
                    <Canvas.Top>
                        <MultiBinding Converter="{StaticResource RelativePositionConverter}">
                            <Binding Path="EndY"/>
                            <Binding Path="Y"/>
                        </MultiBinding>
                    </Canvas.Top>
                </Ellipse>
            </Canvas>
            <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsOccupied}" Value="True">
                    <Setter TargetName="TrackLine" Property="Stroke" Value="Red"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="#F0F0F0" BorderBrush="#CCC" BorderThickness="0,0,0,1" Padding="5">
            <StackPanel Orientation="Horizontal">
                <ItemsControl ItemsSource="{Binding SignalTools}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Command="{Binding Command}" Margin="2" Padding="2" ToolTip="{Binding Type}">
                                <Image x:Name="SignalIcon" Source="{StaticResource SignalMainIcon}" Width="40" Height="20"/>
                            </Button>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding Type}" Value="Main3">
                                    <Setter TargetName="SignalIcon" Property="Source" Value="{StaticResource Signal3Icon}"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="Main45">
                                    <Setter TargetName="SignalIcon" Property="Source" Value="{StaticResource Signal4Icon}"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="Shunt">
                                    <Setter TargetName="SignalIcon" Property="Source" Value="{StaticResource SignalShuntIcon}"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <Button Command="{Binding AddSwitchCommand}" Margin="2" Padding="5" ToolTip="Add Switch">
                    <TextBlock Text="🔀" FontSize="16"/>
                </Button>
                <Button Command="{Binding AddTrackCircuitCommand}" Margin="2" Padding="5" ToolTip="Add Track Circuit">
                    <TextBlock Text="🛤" FontSize="16"/>
                </Button>
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                <Button Command="{Binding SaveCommand}" Margin="2" Padding="5" ToolTip="Save Track">
                    <TextBlock Text="💾" FontSize="16"/>
                </Button>
                <Button Command="{Binding LoadCommand}" Margin="2" Padding="5" ToolTip="Load Track">
                    <TextBlock Text="📂" FontSize="16"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Property Panel (Left) -->
            <Border Grid.Column="0" Background="#F0F0F0" BorderBrush="#CCC" BorderThickness="0,0,1,0" Padding="10">
                <StackPanel>
                    <TextBlock Text="Properties" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>
                    
                    <ContentControl Content="{Binding SelectedComponent}">
                        <ContentControl.Resources>
                            <!-- Signal Properties -->
                            <DataTemplate DataType="{x:Type models:Signal}">
                                <StackPanel>
                                    <TextBlock Text="ID"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="X"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Y"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Type"/>
                                    <ComboBox ItemsSource="{Binding Source={StaticResource SignalTypeEnum}}" SelectedItem="{Binding Type, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    
                                    <!-- Signal Options -->
                                    <CheckBox Content="Has Guide (유도신호)" IsChecked="{Binding HasGuide}" Margin="0,5,0,0">
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main3">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main45">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>

                                    <CheckBox Content="Has Route (진로표시)" IsChecked="{Binding HasRoute}" Margin="0,0,0,5">
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main3">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main45">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>

                                    <CheckBox Content="No Guide (무유도)" IsChecked="{Binding HasNoGuide}" Margin="0,0,0,5">
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Type}" Value="Shunt">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>

                                    <CheckBox Content="Siso (시소표시)" IsChecked="{Binding IsSiso}" Margin="0,0,0,5"/>

                                    <CheckBox Content="Has TTB" IsChecked="{Binding HasTtb}" Margin="0,0,0,5">
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main3">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Type}" Value="Main45">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>

                                    <TextBlock Text="Direction"/>
                                    <CheckBox Content="Up Direction" IsChecked="{Binding Direction, Converter={StaticResource DirectionToBooleanConverter}}" Margin="0,0,0,5"/>
                                </StackPanel>
                            </DataTemplate>

                            <!-- Switch Properties -->
                            <DataTemplate DataType="{x:Type models:Switch}">
                                <StackPanel>
                                    <TextBlock Text="ID"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="X"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Y"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Switch Number"/>
                                    <TextBox Text="{Binding SwitchNumber, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <CheckBox Content="Is Reverse" IsChecked="{Binding IsReverse, UpdateSourceTrigger=PropertyChanged}" Margin="0,5"/>
                                    <TextBlock Text="Track ID" Margin="0,5,0,0"/>
                                    <TextBox Text="{Binding TrackId, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <CheckBox Content="Is Occupied" IsChecked="{Binding IsOccupied, UpdateSourceTrigger=PropertyChanged}" Margin="0,5"/>
                                </StackPanel>
                            </DataTemplate>

                            <!-- TrackCircuit Properties -->
                            <DataTemplate DataType="{x:Type models:TrackCircuit}">
                                <StackPanel>
                                    <TextBlock Text="ID"/>
                                    <TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="X"/>
                                    <TextBox Text="{Binding X, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Y"/>
                                    <TextBox Text="{Binding Y, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="Length"/>
                                    <TextBox Text="{Binding Length, Mode=OneWay}" IsReadOnly="True" Background="#EEE" Margin="0,0,0,5"/>
                                    <TextBlock Text="End X"/>
                                    <TextBox Text="{Binding EndX, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <TextBlock Text="End Y"/>
                                    <TextBox Text="{Binding EndY, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,5"/>
                                    <CheckBox Content="Is Occupied" IsChecked="{Binding IsOccupied, UpdateSourceTrigger=PropertyChanged}" Margin="0,5"/>
                                </StackPanel>
                            </DataTemplate>
                        </ContentControl.Resources>
                    </ContentControl>
                </StackPanel>
            </Border>

        <!-- Canvas Area -->
        <!-- Canvas Area -->
        <Grid Grid.Column="1" ClipToBounds="True" MouseLeftButtonDown="OnCanvasMouseLeftButtonDown" MouseDown="OnCanvasMouseDown" MouseMove="OnCanvasMouseMove" MouseLeftButtonUp="OnCanvasMouseLeftButtonUp" MouseUp="OnCanvasMouseUp">
            <Grid.Background>
                <DrawingBrush TileMode="Tile" Viewport="0,0,10,10" ViewportUnits="Absolute">
                    <DrawingBrush.Drawing>
                        <GeometryDrawing>
                            <GeometryDrawing.Geometry>
                                <GeometryGroup>
                                    <LineGeometry StartPoint="0,0" EndPoint="10,0"/>
                                    <LineGeometry StartPoint="0,0" EndPoint="0,10"/>
                                </GeometryGroup>
                            </GeometryDrawing.Geometry>
                            <GeometryDrawing.Pen>
                                <Pen Brush="#E0E0E0" Thickness="1"/>
                            </GeometryDrawing.Pen>
                        </GeometryDrawing>
                    </DrawingBrush.Drawing>
                </DrawingBrush>
            </Grid.Background>
            <ItemsControl ItemsSource="{Binding TrackComponents}">
                <ItemsControl.RenderTransform>
                    <TranslateTransform x:Name="CanvasTranslateTransform"/>
                </ItemsControl.RenderTransform>
                <ItemsControl.LayoutTransform>
                    <ScaleTransform x:Name="CanvasScaleTransform" ScaleX="1" ScaleY="1"/>
                </ItemsControl.LayoutTransform>
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas Background="Transparent"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                        <!-- Simple selection interaction -->
                        <Setter Property="Cursor" Value="Hand"/>
                        <EventSetter Event="MouseLeftButtonDown" Handler="OnComponentMouseLeftButtonDown"/>
                        <EventSetter Event="MouseMove" Handler="OnComponentMouseMove"/>
                        <EventSetter Event="MouseLeftButtonUp" Handler="OnComponentMouseLeftButtonUp"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="Blue" BlurRadius="10" ShadowDepth="0"/>
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ItemsControl.ItemContainerStyle>
            </ItemsControl>
            
            <!-- Selection Box Overlay -->
            <Canvas IsHitTestVisible="False">
                <Rectangle x:Name="SelectionBox" Stroke="Blue" StrokeThickness="1" Fill="#330000FF" Visibility="Collapsed"/>
            </Canvas>
        </Grid>

        </Grid>
    </Grid>
</Window>
